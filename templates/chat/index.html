{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Chat | ChatBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">

  <!-- Estilos del chat -->
  <link rel="stylesheet" href="{% static 'chat/css/index.css' %}">
</head>

<body class="bg-light vh-100 d-flex flex-column">

  <!-- Header -->
  <nav class="navbar navbar-dark neon shadow-sm ">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">
        <i class="fa-solid fa-robot"></i> ChatBot
      </span>

      <div class="d-flex align-items-center gap-2">
        {% if user.is_authenticated %}
        <span class="badge badge-user"><i class="fa-solid fa-user-circle me-1"></i>{{ user.username }}</span>
        {% endif %}
        <form action="{% url 'logout' %}" method="post" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-light btn-sm">
            <i class="fa-solid fa-right-from-bracket"></i> Salir
          </button>
        </form>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <div class="container-fluid flex-grow-1 py-2">
    <div class="row h-100 g-3">

      <!-- Salas (Sidebar izquierda) -->
      <!-- Botón solo en móvil -->
      <button class="btn btn-primary w-100 d-lg-none mb-2" type="button" data-bs-toggle="collapse"
        data-bs-target="#roomsMenu">
        <i class="fa-solid fa-door-open me-2"></i> Salas
      </button>

      <!-- Sidebar izquierda -->
      <div class="col-lg-2 sidebar p-3 rounded-end collapse d-lg-block" id="roomsMenu">
        <h5 class="section-title mb-3"><i class="fa-solid fa-door-open me-2"></i>Salas</h5>
        <div class="list-group">
          <a class="list-group-item list-group-item-action active">
            <i class="fa-solid fa-house me-2"></i>Chat general
          </a>
          {% for room in rooms %}
          <a class="list-group-item list-group-item-action d-flex align-items-center">
            {% if room.name == 'Admin' %}
            <i class="fa-solid fa-door-closed me-2 text-danger"></i>
            {% else %}
            <i class="fa-solid fa-door-open me-2 text-success"></i>
            {% endif %}
            {{ room.name }}
          </a>
          {% endfor %}
        </div>
      </div>


      <!-- Chat principal -->
      <div class="col-md-6 col-lg-7 chat-wrap">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fa-solid fa-message me-2"></i>Mensajes</h5>
          <span class="text-light opacity-75 small">Los mensajes en esta sala son temporales.</span>
        </div>

        <!-- Mensajes -->
        <div id="chat-messages" class="shadow-sm">
          {% for message in messages %}
          {% if message.user == user %}
          <div class="msg me">
            <div class="w-100">
              <div class="author mb-1">
                <span class="badge">{{ message.user.username }}</span>
              </div>
              <div class="bubble">{{ message.content }}</div>
            </div>
          </div>
          {% else %}
          <div class="msg other">
            <div class="w-100">
              <div class="author mb-1">
                <span class="badge">{{ message.user.username }}</span>
              </div>
              <div class="bubble">{{ message.content }}</div>
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </div>

        <!-- Formulario -->
        <form id="chat-form" class="input-group">
          <input type="text" name="message" id="message" class="form-control" placeholder="Escribe algo..." autofocus>
          <button type="submit" class="btn btn-success" id="send-btn">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </form>
      </div>

      <!-- Usuarios / Notificaciones (Sidebar derecha) -->
      <div class="col-md-3 col-lg-3 sidebar right p-3 rounded-start">
        <h5 class="section-title mb-3"><i class="fa-solid fa-bell me-2"></i>Notificaciones</h5>
        <div id="notifications" class="panel mb-4"></div>

        <h5 class="section-title mb-3"><i class="fa-solid fa-users me-2"></i>Usuarios en esta sala</h5>
        <ul class="list-group" id="users"></ul>
      </div>

    </div>
  </div>

  <script>
    // Exponemos username para tu index.js (websocket)
    username = "{{ user.username }}";
    // Auto-scroll al final al cargar
    window.addEventListener('load', () => {
      const box = document.getElementById('chat-messages');
      if (box) box.scrollTop = box.scrollHeight;
    });
  </script>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="{% static 'chat/js/index.js' %}"></script>
</body>

</html>